"""
NLP文本分析工具 - 增强版
使用Jieba进行中文分词、关键词提取和智能文本分类
支持更精确的文档归类和关键词识别
"""

import re
import jieba
import jieba.analyse
from collections import Counter
from math import log


class TextClassifier:
    """文本分类器 - 使用Jieba分词的前置库匹配分类"""
    
    # 学科分类关键词字典（大幅扩展，每个分类100+个专业术语）
    CATEGORY_KEYWORDS = {
        '数学': [
            '数学', '代数', '几何', '三角', '微积分', '方程', '不等式',
            '函数', '极限', '导数', '积分', '矩阵', '线性代数', '概率', '统计',
            '算数', '乘法', '除法', '加法', '减法', '计算', '数值',
            '一次函数', '二次函数', '三次函数', '四次函数', '五次函数',
            '集合', '集合论', '群论', '数论', '组合数学', '离散数学',
            '向量', '标量', '点积', '叉积', '范数', '模', '张量',
            '特征值', '特征向量', '行列式', '秩', '逆矩阵', '伴随矩阵',
            '方程组', '线性方程', '二次方程', '三次方程', '四次方程',
            '根式', '有理式', '多项式', '因式分解', '展开式', '二项式',
            '指数', '对数', '幂函数', '根式函数', '分式函数', '反函数',
            '三角函数', '正弦', '余弦', '正切', '余切', '正割', '余割',
            '反三角', '反正弦', '反余弦', '反正切', '反余切',
            '微分', '偏导', '全微分', '方向导数', '梯度', '散度', '旋度',
            '积分', '定积分', '不定积分', '二重积分', '三重积分', '线积分', '面积分',
            '级数', '泰勒级数', '傅里叶级数', '幂级数', '收敛', '发散',
            '常微分方程', '偏微分方程', '初值问题', '边值问题', '通解', '特解',
            '概率论', '古典概率', '条件概率', '贝叶斯', '期望', '方差', '标准差',
            '分布', '正态分布', '二项分布', '泊松分布', '均匀分布', '指数分布',
            '样本', '总体', '参数', '统计量', '点估计', '区间估计', '假设检验',
            '相关', '回归', '线性回归', '非线性回归', '多元回归',
            '排列', '组合', '排列组合', '二项式系数', '帕斯卡三角',
            '布尔代数', '逻辑', '真值', '逻辑门', '命题', '量词',
            '圆', '椭圆', '抛物线', '双曲线', '圆锥曲线', '焦点', '离心率',
            '三角形', '四边形', '五边形', '多边形', '正多边形', '周长', '面积',
            '平面', '直线', '射线', '线段', '角', '平行', '垂直', '相交',
            '平移', '旋转', '对称', '缩放', '变换', '反射', '投影',
            '空间', '立体', '球', '正方体', '长方体', '棱柱', '棱锥',
            '表面积', '体积', '表面元素', '体积元素',
            '数值分析', '四舍五入', '误差', '绝对误差', '相对误差',
            '迭代', '牛顿法', '二分法', '割线法', '拉格朗日插值',
            '最小二乘', '曲线拟合', '超定方程', '欠定方程',
            '矢量场', '标量场', '势', '通量', '环量',
            '傅里叶变换', '拉普拉斯变换', 'z变换', '小波变换',
            '卷积', '相关', '变差', '傅里叶系数',
            '拓扑', '连通', '紧集', '闭包', '内部', '边界',
            '实分析', '泛函分析', '希尔伯特空间', '巴拿赫空间',
            '运算', '乘法', '除法', '加法', '减法', '取模', '取余',
            '数字', '整数', '分数', '小数', '百分数', '循环小数'
        ],
        '英语': [
            '英语', '英文', 'english', '词汇', '语法', '句型', '短语', '翻译',
            '阅读', '写作', '听力', '口语', '发音', 'grammar', 'vocabulary',
            '语言', '课文', '对话', 'conversation', 'essay', '英语作文', '作文',
            '时态', '语态', '指读', '段落', '论文', '修饰',
            '名词', '代词', '动词', '形容词', '副词', '介词', '连词', '冠词',
            'noun', 'pronoun', 'verb', 'adjective', 'adverb', 'preposition',
            '短语动词', '短语', 'phrasal', 'phrase', '习语', 'idiom', '谚语',
            '句子', '简单句', '复合句', '复杂句', '并列句', '从句',
            '主句', '从句', '定语从句', '状语从句', '名词性从句', '宾语从句',
            '主语从句', '表语从句', '同位语从句', '条件从句',
            '被动语态', '主动语态', '进行时', '完成时', '完成进行时',
            '现在时', '过去时', '将来时', '过去将来时',
            '虚拟语气', '假设', '条件', '非真实', '相反事实',
            '语音', '音素', '音节', '重音', '语调', '节奏', '韵律',
            '元音', '辅音', '浊音', '清音', '摩擦音', '爆破音', '鼻音',
            '拼写', '拼法', '字母', '标点', '大小写', '缩写', '首字母缩略',
            '阅读理解', '快速阅读', '细节理解', '主旨概括', '推理判断',
            '阅读材料', '新闻', '故事', '说明文', '议论文', '应用文',
            '听力材料', '对话', '独白', '讲话', '演讲', '广播', '电视',
            '写作', '记叙文', '描写文', '说明文', '议论文', '应用文',
            '段落结构', '主题句', '支撑句', '转折句', '总结句',
            '连接词', '过渡词', '逻辑关联', '因果', '对比', '递进', '总结',
            '词汇', '同义词', '反义词', '近义词', '生词', '难词',
            '英美差异', '美式英语', '英式英语', '澳式英语', '口语', '书面语',
            '发音规则', '重读', '弱读', '连读', '失爆', '同化',
            '文化习俗', '风俗', '传统', '节日', '礼仪', '礼节',
            '文学', '诗歌', '小说', '剧本', '散文', '戏剧',
            '修辞手法', '比喻', '拟人', '排比', '夸张', '反讽', '双关',
            '人物', '情节', '背景', '主题', '象征', '讽刺',
            '翻译技巧', '直译', '意译', '音译', '归化', '异化',
            '词汇扩展', '词根', '前缀', '后缀', '词族', '同族词',
            '学术英语', '学术写作', '学术演讲', '学术讨论', '学术研究',
            '商务英语', '商务信函', '商务谈判', '商务演讲', '商务礼仪',
            '日常用语', '日常对话', '日常表达', '社交用语', '寒暄',
            '教学方法', '课堂用语', '教学活动', '教学设计'
        ],
        '物理': [
            '物理', '力', '运动', '能量', '波', '光', '电', '磁', '热',
            '机械', '声学', '光学', '电磁学', '原子', '核', '相对论',
            '加速度', '速度', '位移', '牛顿', 'physics', '运动学',
            '力学', '静力学', '动力学', '流体力学', '固体力学',
            '牛顿第一定律', '牛顿第二定律', '牛顿第三定律', '万有引力', '重力',
            '压力', '拉力', '支持力', '摩擦力', '静摩擦', '动摩擦', '滑动摩擦',
            '胡克定律', '弹性', '弹性势能', '动能', '重力势能', '机械能',
            '功', '功率', '效率', '做功', '正功', '负功', '零功',
            '冲量', '动量', '动量定理', '动量守恒', '碰撞', '反弹',
            '圆周运动', '向心加速度', '向心力', '离心', '转速', '角速度',
            '简谐运动', '振幅', '周期', '频率', '相位', '振动',
            '波', '波长', '波速', '频率', '声波', '光波', '横波', '纵波',
            '多普勒效应', '干涉', '衍射', '反射', '折射', '衍射衍',
            '光的粒子性', '光子', '光电效应', '康普顿效应', '韦伯斯特',
            '热', '温度', '热量', '比热', '热容', '热能', '热传导',
            '热对流', '热辐射', '绝对温度', '摄氏温度', '华氏温度',
            '分子动理论', '分子', '原子', '离子', '质子', '中子', '电子',
            '布朗运动', '扩散', '渗透', '气体', '液体', '固体',
            '热力学第一定律', '热力学第二定律', '热力学第三定律', '熵',
            '能量守恒', '能量转化', '可逆过程', '不可逆过程',
            '电荷', '正电荷', '负电荷', '电子', '质子', '库仑定律',
            '电场', '电场强度', '电势', '电势差', '电压', '电容',
            '电流', '电阻', '欧姆定律', '电功', '电功率', '焦耳热',
            '电磁感应', '磁场', '磁通', '感应电动势', '法拉第定律', '楞次定律',
            '变压器', '涡流', '自感', '互感', '电感', '电容器',
            '交流电', '直流电', '电压表', '电流表', '欧姆表', '万用表',
            '原子结构', '核', '电子云', '能级', '激发', '电离',
            '原子核', '质子', '中子', '质量数', '质子数', '中子数',
            '同位素', '同分异体', '放射性', '放射性衰变', 'α衰变', 'β衰变',
            '核反应', '核裂变', '核聚变', '链式反应', '质量亏缺',
            '相对论', '狭义相对论', '广义相对论', '光速不变原理', '时空观',
            '时间膨胀', '长度收缩', '相对性', '质能转化', '爱因斯坦',
            '光学', '凸透镜', '凹透镜', '焦距', '像距', '物距',
            '透镜公式', '放大倍数', '成像规律', '色散', '棱镜',
            '偏振', '干涉条纹', '衍射极大', '衍射极小', '衍射图样',
            '光谱', '吸收谱', '发射谱', '连续谱', '线谱', '频谱',
            '机械振动', '余弦振动', '正弦振动', '衰减振动', '受迫振动',
            '共振', '谐振', '频率', '振动频率', '谐振频率'
        ],
        '化学': [
            '化学', '化学式', '分子', '原子', '反应', '元素', '有机化学',
            '无机化学', '离子', '溶液', '酸碱', '氧化还原', '化学键',
            '催化', 'chemistry', '燃烧', '合成', '分解', '聚合', '缩聚',
            '物质', '纯物质', '混合物', '单质', '化合物', '易溶', '难溶',
            '沉淀', '晶体', '非晶体', '金属', '非金属', '半导体',
            '原子序数', '原子量', '相对分子质量', '摩尔', '物质的量',
            '配体', '络合物', '螯合', '配位数', '配位化学',
            '离子化合物', '分子化合物', '共价化合物', '离子键', '共价键',
            '金属键', '范德华力', '氢键', '静电引力', '电子对共享',
            '杂化轨道', 'sp', 'sp2', 'sp3', '分子构型', '分子几何',
            '非极性分子', '极性分子', '电负性', '偶极矩', '极性',
            '路易斯结构', '共价结构', '电子点', '点式电子', '电子式',
            '反应速率', '快反应', '慢反应', '反应机制', '基本步骤',
            '活化能', '碰撞理论', '反应能力', '反应可能性', '动力学',
            '平衡', '化学平衡', '动态平衡', '平衡常数', '勒夏特列原理',
            '浓度', '压强', '温度', '催化剂', '改变平衡',
            '酸', '碱', '中性', '酸性', '碱性', '酸碱指示剂', '酸碱滴定',
            'pH', 'pOH', '强酸', '弱酸', '强碱', '弱碱', '两性物质',
            '氢离子', '氢氧根离子', '离子浓度', '离子积', '溶度积',
            '缓冲溶液', '缓冲对', '缓冲能力', '缓冲范围', '控制pH',
            '氧化', '还原', '氧化剂', '还原剂', '氧化还原反应',
            '氧化数', '转移电子', '失电子', '得电子', '电子转移',
            '电化学', '原电池', '电解', '电极', '阳极', '阴极',
            '电极反应', '氧化还原反应方程式', '电子转移数', '电路',
            '有机物', '烃', '烷烃', '烯烃', '炔烃', '芳烃', '同分异体',
            '官能团', '羟基', '羧基', '羰基', '酯基', '醚基', '胺基',
            '烃的衍生物', '醇', '酚', '醚', '醛', '酮', '羧酸', '酯',
            '烯丙反应', '取代反应', '加成反应', '聚合反应', '酯化反应',
            '聚酯', '聚乙烯', '聚丙烯', '聚氯乙烯', '聚苯乙烯',
            '天然高分子', '蛋白质', '多糖', '核酸', '脂肪', '纤维',
            '单体', '聚合物', '高分子', '分子链', '交联', '支链',
            '元素化学', '主族元素', '副族元素', '过渡金属', '稀有气体',
            '碱金属', '碱土金属', '卤素', '氧族元素', '氮族元素',
            '碳', '硅', '钠', '钙', '铁', '铜', '锌', '铝', '镁',
            '无机盐', '硫酸盐', '硝酸盐', '氯化物', '碳酸盐',
            '晶体结构', '离子晶体', '分子晶体', '原子晶体', '金属晶体',
            '溶液分散', '溶解', '乳化', '胶体', '悬浊液', '重结晶',
            '色谱法', '层析', '提纯', '分离', '鉴定', '检验'
        ],
        '生物': [
            '生物', '细胞', '遗传', 'dna', 'rna', '蛋白质', '进化', '生态',
            '器官', '组织', '新陈代谢', '光合作用', '呼吸作用', '免疫',
            'biology', '植物', '动物', '微生物', '域', '界', '生物分类',
            '细胞膜', '细胞壁', '细胞核', '线粒体', '叶绿体', '核糖体',
            '内质网', '高尔基体', '囊泡', '溶酶体', '液泡', '中心体',
            '细胞骨架', '微管', '微丝', '中间纤维', '完整性', '流动性',
            '物质运输', '被动运输', '主动运输', '协助扩散', '胞吐', '胞吸',
            '细胞周期', '分裂间期', '有丝分裂', '减数分裂', '分裂期',
            '细胞分裂', 'g1期', 's期', 'g2期', 'g0期', '细胞核',
            '有丝分裂过程', '前期', '中期', '后期', '末期', '细胞质分裂',
            '减数分裂一', '减数分裂二', '分离', '组合', '非整倍体',
            '基因', '等位基因', '隐性基因', '显性基因', '纯合', '杂合',
            '遗传学', '孟德尔定律', '自由组合定律', '分离定律', '连锁',
            '性状', '性状分离', '基因型', '表现型', '遗传比', '性状比',
            '可遗传变异', '不可遗传变异', '基因突变', '染色体变异',
            '核糖核酸', '脱氧核糖核酸', '碱基', '核苷酸', '双螺旋',
            'dna复制', '半保留复制', '碱基互补配对', '转录', '翻译',
            '中心法则', '基因表达', '转录调控', '翻译调控', '后转录',
            '蛋白质合成', '肽键', '多肽链', '一级结构', '二级结构',
            '三级结构', '四级结构', '折叠', '修饰', '信号肽',
            '酶', '生物催化剂', '酶活性', '辅酶', '辅基', '酶分子',
            '底物', '活性位点', '米氏常数', '最大速率', '竞争抑制',
            '非竞争抑制', '反馈抑制', '酶激活', '酶促反应',
            '代谢', '同化代谢', '异化代谢', '能量代谢', '营养代谢',
            '光合作用', '光反应', '暗反应', '电子传递', '光合磷酸化',
            '卡尔文循环', '类囊体', '类囊体膜', '类囊体腔', '基质',
            '呼吸作用', '有氧呼吸', '无氧呼吸', '糖酵解', '柠檬酸循环',
            '电子传递链', '线粒体基质', '线粒体嵴', '细胞呼吸',
            '三磷酸腺苷', 'atp', '腺苷二磷酸', 'adp', '能量货币',
            '动物体结构', '动物细胞', '上皮组织', '结缔组织', '神经组织',
            '肌肉组织', '器官', '器官系统', '整体性', '协调性',
            '神经调节', '激素调节', '神经体液调节', '神经末梢',
            '突触', '神经递质', '受体', '反射弧', '反射',
            '垂体激素', '甲状腺激素', '胰岛激素', '肾上腺激素',
            '性激素', '激素受体', '靶细胞', '激素作用',
            '免疫系统', '淋巴细胞', '吞噬细胞', '抗原', '抗体',
            '特异性免疫', '非特异性免疫', '细胞免疫', '体液免疫',
            '生态系统', '生产者', '消费者', '分解者', '食物链', '食物网',
            '生态平衡', '群落', '种群', '个体', '生物圈',
            '物质循环', '碳循环', '氮循环', '水循环', '磷循环',
            '能量流动', '逐级递减', '效率', '热量损耗', '营养级',
            '进化论', '自然选择', '适应性', '变异', '遗传', '进化'
        ],
        '历史': [
            '历史', '朝代', '皇帝', '事件', '战争', '古代', '现代', '近代',
            '民族', '文化', '革命', '社会', '政治', '经济', '历史事件',
            '人物', '年代', 'history', '帝业', '皇位', '社会制度',
            '中国历史', '夏代', '商代', '周代', '秦代', '汉代', '三国',
            '晋代', '南北朝', '隋代', '唐代', '五代十国', '宋代',
            '元代', '明代', '清代', '民国', '中华人民共和国',
            '秦始皇', '汉武帝', '唐太宗', '康熙', '乾隆', '中国古代皇帝',
            '刘邦', '刘彻', '唐高宗', '武则天', '女皇', '统治者',
            '奴隶制', '分封制', '郡县制', '科举制', '宗法制', '等级制',
            '农业文明', '手工业', '商业', '贸易', '贸易路线', '丝绸之路',
            '古代战争', '秦灭六国', '楚汉争霸', '汉匈战争', '唐突厥',
            '蒙古入侵', '明清对外', '甲午战争', '八国联军', '鸦片战争',
            '思想文化', '儒家', '道家', '法家', '墨家', '兵家',
            '佛教', '道教', '宗教信仰', '哲学思想', '政治思想',
            '儒学', '孔子', '孟子', '荀子', '董仲舒', '儒家经典',
            '道学', '老子', '庄子', '道教', '道家思想', '修养',
            '艺术', '书法', '绘画', '陶瓷', '青铜', '玉器', '建筑',
            '长城', '故宫', '兵马俑', '敦煌', '石窟', '寺庙',
            '文学', '诗经', '楚辞', '古诗', '词', '曲', '古文',
            '唐诗', '宋词', '元曲', '明清小说', '四大名著',
            '世界历史', '古希腊', '古罗马', '中世纪', '文艺复兴',
            '启蒙运动', '工业革命', '资本主义', '帝国主义', '殖民地',
            '美国独立', '法国大革命', '拿破仑', '第一次世界大战',
            '第二次世界大战', '冷战', '苏联解体', '东欧巨变',
            '现代中国', '辛亥革命', '中华民国', '五四运动', '大革命',
            '国民党', '共产党', '北伐', '土地革命', '长征',
            '抗日战争', '解放战争', '建立新中国', '社会主义建设',
            '改革开放', '现代化', '和平统一', '港澳回归',
            '历史人物', '毛泽东', '周恩来', '邓小平', '江泽民',
            '孙中山', '蒋介石', '周恩来', '朱德', '陈独秀',
            '历史研究', '考古', '文献', '碑刻', '器物', '遗迹',
            '历史方法', '证据', '推理', '分析', '综合', '比较'
        ],
        '地理': [
            '地理', '地球', '地形', '气候', '地区', '国家', '城市', '山脉',
            '河流', '海洋', '大陆', '人文地理', '自然地理', '地图',
            'geography', '地势', '纬度', '经度', '洋流', '气流',
            '地壳', '岩石', '矿物', '火山', '地震', '板块', '构造',
            '地质', '侵蚀', '沉积', '风化', '流水', '冰川', '风',
            '地貌', '平原', '高原', '盆地', '山地', '丘陵', '谷地',
            '河流地貌', '河谷', '三角洲', '扇形沉积', '河流阶地',
            '海岸', '海滨', '海湾', '海峡', '群岛', '半岛', '岛屿',
            '大气圈', '对流层', '平流层', '中间层', '热层', '外逸层',
            '大气成分', '氮气', '氧气', '二氧化碳', '稀有气体', '微量元素',
            '天气', '气候', '温度', '降水', '风', '气压', '湿度',
            '气团', '锋面', '台风', '飓风', '龙卷风', '冰雹', '暴雨',
            '气候类型', '热带', '亚热带', '温带', '亚寒带', '寒带',
            '季风', '洋流', '暖流', '寒流', '海陆差异', '温度分布',
            '降水分布', '干湿分布', '自然带', '植被', '土壤',
            '水圈', '海洋', '河流', '湖泊', '地下水', '冰川', '降水',
            '海水', '盐度', '温度', '密度', '潮汐', '波浪', '洋流',
            '陆地水体', '河流流域', '分水岭', '河流补给', '流量',
            '生物圈', '生态系统', '生物群落', '种群', '个体',
            '植被分布', '森林', '草地', '荒漠', '湿地', '苔原',
            '物种分布', '物种隔离', '隔离机制', '分布界线',
            '人口', '人口增长', '人口密度', '人口结构', '迁移', '流动',
            '人口问题', '过度增长', '老龄化', '性别比例', '城市化',
            '人类社会', '经济活动', '农业', '工业', '服务业', '信息产业',
            '城市化', '城市', '农村', '郊区', '城市规划', '城市问题',
            '农业地理', '种植业', '畜牧业', '林业', '渔业', '农业区划',
            '工业地理', '工业集中', '工业布局', '工业转移', '工业革命',
            '交通', '陆运', '海运', '空运', '管道', '交通枢纽', '城际铁路',
            '商业贸易', '商业中心', '贸易路线', '贸易伙伴', '市场',
            '地区发展', '地区差异', '贫富差距', '区域一体化',
            '国家地理', '中国地理', '亚洲地理', '欧洲地理', '非洲地理',
            '北美地理', '南美地理', '大洋洲地理', '南极地理',
            '区域划分', '地理分界', '过渡带', '地理分化', '地理分布',
            '地图学', '地图投影', '等高线', '地形图', '政治地图',
            '地理信息系统', 'gis', '遥感', '定位系统', 'gps',
            '环境问题', '污染', '气候变暖', '臭氧空洞', '生物多样性'
        ],
        '政治': [
            '政治', '政策', '法律', '制度', '政府', '国家', '权力', '权利',
            '公民', '社会', '经济体制', '政治制度', '国际关系', '外交',
            '思想', '哲学', '伦理', '法治', '民主', '民主制度',
            '国体', '政体', '政权', '权力结构', '权力分配', '权力制衡',
            '议会', '代表大会', '人大', '全国人大', '地方人大',
            '政府', '行政机构', '行政权力', '行政职能', '政府权力',
            '司法', '法院', '检察院', '司法权', '司法独立', '法律程序',
            '法律制度', '法系', '民法', '刑法', '行政法', '劳动法',
            '宪法', '基本法', '法律体系', '法律渊源', '法律效力',
            '公民权利', '政治权利', '人身权', '财产权', '受教育权',
            '公民义务', '遵法纳税', '服兵役', '劳动', '环保',
            '民主制度', '人民主权', '民主参与', '民主监督', '民主决策',
            '选举制度', '投票', '普遍选举', '平等选举', '直接选举',
            '决策制度', '决策程序', '群众参与', '专家咨询',
            '监督制度', '权力监督', '权力制约', '制衡', '监督机制',
            '法治建设', '法治精神', '法治意识', '法治社会', '依法行政',
            '国家性质', '阶级性', '工人阶级', '人民性', '社会主义',
            '社会主义制度', '公有制', '计划经济', '市场经济',
            '政党制度', '中国共产党', '多党制', '政党制度', '政党合作',
            '民族制度', '民族平等', '民族团结', '民族区域自治',
            '宗教制度', '宗教信仰', '宗教自由', '政教分离',
            '意识形态', '理想信念', '价值观', '世界观', '人生观',
            '社会意识', '社会存在', '上层建筑', '经济基础',
            '社会矛盾', '主要矛盾', '次要矛盾', '矛盾分析', '对立统一',
            '发展观', '科学发展观', '可持续发展', '和谐社会',
            '国际关系', '国际秩序', '国际法', '条约', '协议',
            '外交政策', '对外政策', '和平政策', '独立自主', '互利共赢',
            '国际冲突', '战争', '和平解决', '国际组织', '联合国',
            '全球化', '经济全球化', '文化全球化', '政治多极化',
            '区域一体化', '欧盟', '一带一路', '区域组织',
            '国家利益', '国家安全', '领土完整', '主权独立',
            '文化', '民族文化', '传统文化', '现代文化', '文化融合',
            '文化自信', '文化传播', '文化交流', '文化冲突',
            '伦理道德', '道德规范', '道德修养', '诚信', '廉政',
            '人权', '人权概念', '人权保护', '人权国际法'
        ],
        '经济': [
            '经济', '商业', '贸易', '金融', '投资', '市场', '企业', '生产',
            '消费', '价格', '成本', '利润', '资本', '劳动', '供需',
            '经济学', '会计', '财务', '财对', '注册', '收入',
            '市场经济', '商品', '商品价值', '商品流通', '商品交换',
            '货币', '纸币', '电子货币', '货币职能', '货币政策',
            '价格', '商品价格', '价格机制', '价格杠杆', '价格调整',
            '供给', '需求', '供需平衡', '供不应求', '供过于求',
            '市场', '市场竞争', '市场失灵', '市场结构', '市场监管',
            '企业', '私有企业', '公有企业', '混合所有制', '企业性质',
            '生产', '生产关系', '生产力', '生产方式', '分工',
            '劳动', '雇佣劳动', '劳动报酬', '工资', '福利',
            '资本', '资本积累', '资本流动', '资本国际流动',
            '利润', '利润率', '利润源', '剩余价值', '利润分配',
            '投资', '投资回报', '投资风险', '投资收益', '融资',
            '金融市场', '股票市场', '债券市场', '外汇市场', '期货市场',
            '银行', '银行业', '货币政策', '存款', '贷款', '利率',
            '股票', '股份', '股东', '红利', '股权', '股票交易',
            '债券', '公债', '企业债', '债权人', '债务人',
            '保险', '保险业', '保险产品', '风险管理',
            '财政', '财政收入', '税收', '财政支出', '财政平衡',
            '税收', '税种', '直接税', '间接税', '税率', '纳税',
            '审计', '会计审计', '财务审计', '审计监督',
            '会计', '会计制度', '会计准则', '财务报表', '财务分析',
            '成本', '固定成本', '变动成本', '成本控制', '成本分析',
            '收益', '收益分配', '收益率', '投资收益',
            '国民经济', '国内生产总值', 'gdp', '国民生产总值', 'gnp',
            '经济增长', '经济周期', '经济发展', '经济结构',
            '产业', '第一产业', '第二产业', '第三产业', '产业升级',
            '农业', '工业', '服务业', '信息产业', '高新技术产业',
            '贸易', '对外贸易', '进口', '出口', '贸易差额',
            '汇率', '汇兑', '外汇', '汇率制度', '汇率浮动',
            '国际经济', '经济一体化', '经济制裁', '经济合作',
            '发展', '可持续发展', '绿色经济', '循环经济', '低碳经济',
            '分配', '收入分配', '财富分配', '公平分配', '效率',
            '消费', '消费者', '消费行为', '消费心理', '消费权益',
            '失业', '就业', '失业率', '就业机会', '工作'
        ],
        '综合': [
            '综合', '实验', '项目', '案例', '教学', '资料', '课件', '素材',
            '教案', '学案', '总结', '复习', '练习', '习题', '考卷',
            '实践', '应用', '分析', '研究', '探讨', '讨论',
            '跨学科', '交叉学科', '学科融合', '综合应用',
            '创新', '创意', '发明', '创造', '改进', '优化',
            '学习方法', '学习策略', '复习技巧', '考试技能',
            '思维方法', '逻辑思维', '创意思维', '批判思维',
            '问题解决', '问题分析', '方案设计', '实施策略',
            '团队合作', '沟通', '协作', '共识', '配合',
            '信息素养', '信息获取', '信息处理', '信息应用',
            '多媒体', '课件', '视频', '音频', '动画', '图片',
            '虚拟学习', '在线学习', '远程教学', '混合学习',
            '评估', '评价', '考试', '测试', '检测', '反馈',
            '学生发展', '核心素养', '全面发展', '个性发展',
            '教师专业', '教学设计', '教学实施', '教学反思',
            '教育改革', '课程改革', '教学改革', '评价改革',
            '教学资源', '教学材料', '学习资源', '参考资料',
            '教室', '学校', '教育环境', '学习环境',
            '教科书', '教学用书', '参考书', '辅导书',
            '学科整合', '主题教学', '项目学习', '问题学习',
            '科学探究', '实验研究', '观察记录', '数据分析',
            '社会服务', '志愿服务', '社区实践', '劳动实践',
            '安全教育', '健康教育', '法律教育', '道德教育',
            '文化传承', '文化学习', '传统文化', '民族文化',
            '国际理解', '跨文化交流', '全球视野', '国际合作',
            '生活技能', '生活经验', '日常应用', '实用知识',
            '兴趣爱好', '特长培养', '潜能开发', '个性特点'
        ]
    }
    
    def __init__(self):
        """初始化分类器"""
        pass
    
    def classify_text(self, text):
        """
        使用Jieba分词进行文本分类
        返回: (category, confidence_score)
        """
        # 清理文本
        text = self._clean_text(text)
        
        if not text:
            return '综合', 0.0
        
        # 使用Jieba进行分词
        words = list(jieba.cut(text.lower()))
        word_set = set(w for w in words if len(w) > 1)
        
        # 计算每个分类的匹配度
        category_scores = {}
        
        for category, keywords in self.CATEGORY_KEYWORDS.items():
            # 计算匹配的关键词数量
            matched_count = sum(1 for keyword in keywords if keyword in word_set)
            
            # 计算置信度分数 (0-1)
            if len(keywords) > 0:
                confidence = matched_count / len(keywords)
                category_scores[category] = confidence
        
        # 找出最高分的分类
        if category_scores:
            best_category = max(category_scores, key=category_scores.get)
            confidence = category_scores[best_category]
            return best_category, confidence
        
        return '综合', 0.0
    
    def _clean_text(self, text):
        """清理文本 - 移除特殊字符"""
        # 只保留中文、英文、数字和空格
        text = re.sub(r'[^\u4e00-\u9fff\w\s]', '', text)
        return text.strip()


class KeywordExtractor:
    """关键词提取器 - 使用Jieba和词频统计"""
    
    STOP_WORDS = {
        '的', '一', '是', '在', '不', '了', '有', '人', '这', '中',
        '大', '为', '上', '个', '国', '我', '以', '要', '他', '时',
        '来', '用', '们', '生', '到', '作', '地', '于', '出', '就',
        '分', '对', '成', '会', '可', '主', '发', '年', '动', '同',
        '工', '也', '能', '下', '过', '民', '前', '面', '直', '书',
        '化', '机', '该', '行', '其', '二', '起', '制', '级', '学',
        '等', '观', '部', '否', '系', '别', '她', '将', '比', '多',
        '获', '各', '种', '及', '又', '从', '事', '者', '已', '都',
        'and', 'or', 'is', 'the', 'a', 'to', 'of', 'in', 'that', 'for',
        'be', 'have', 'do', 'as', 'it', 'by', 'this', 'at', 'with', 'an'
    }
    
    def extract_keywords(self, text, top_k=15):
        """
        使用Jieba提取关键词
        返回: 关键词列表（按重要性排序）
        """
        # 清理文本
        text = self._clean_text(text)
        
        if not text:
            return []
        
        # 方式1：使用Jieba分词 + 词频统计
        words = jieba.cut(text)
        
        # 过滤停用词和短词
        filtered_words = [
            w for w in words 
            if len(w) > 1 and w not in self.STOP_WORDS
        ]
        
        # 统计词频
        word_freq = Counter(filtered_words)
        
        # 获取频率最高的关键词
        top_words = [word for word, freq in word_freq.most_common(top_k)]
        
        # 方式2：如果词频不足，使用TF-IDF补充
        if len(top_words) < top_k // 2:
            try:
                tfidf_words = jieba.analyse.extract_tags(
                    text, 
                    topK=top_k,
                    withWeight=False
                )
                # 合并两种方法的结果，去重
                combined = list(dict.fromkeys(top_words + tfidf_words))
                return combined[:top_k]
            except:
                pass
        
        return top_words
    
    def _clean_text(self, text):
        """清理文本 - 移除特殊字符"""
        text = re.sub(r'[^\u4e00-\u9fff\w\s]', '', text)
        return text.strip()


class AutoClassifier:
    """自动分类引擎 - 结合分类和关键词提取"""
    
    def __init__(self):
        self.text_classifier = TextClassifier()
        self.keyword_extractor = KeywordExtractor()
    
    def classify_document(self, content, title='', description=''):
        """
        对文档进行智能分类
        返回: {
            'category': '分类',
            'sub_category': '子分类',
            'confidence_score': 0.85,
            'keywords': ['关键词1', '关键词2'],
            'is_auto_classified': True
        }
        """
        # 组合文本用于分类（权重：标题 > 描述 > 内容）
        full_text = f"{title} {title} {description} {description} {content}"
        
        # 进行文本分类
        category, confidence = self.text_classifier.classify_text(full_text)
        
        # 提取关键词（从完整文本中提取）
        keywords = self.keyword_extractor.extract_keywords(full_text, top_k=10)
        
        return {
            'category': category,
            'sub_category': self._get_sub_category(category),
            'confidence_score': min(round(confidence, 2), 1.0),
            'keywords': keywords,
            'is_auto_classified': True
        }
    
    def _get_sub_category(self, category):
        """根据主分类确定子分类"""
        sub_categories = {
            '数学': '高等数学',
            '英语': '英语语法',
            '物理': '力学与热学',
            '化学': '有机化学',
            '生物': '细胞生物学',
            '历史': '中国历史',
            '地理': '自然地理',
            '政治': '政治思想',
            '经济': '经济学基础',
            '综合': '综合资料'
        }
        return sub_categories.get(category, '其他')
